name: Translation Validation

on:
  push:
    branches: [ master, main ]
    paths:
      - 'index*.html'
      - 'scripts/validate-translations.js'
      - '.github/workflows/translation-validation.yml'
      - 'TRANSLATION_GUIDE.md'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'index*.html'
      - 'scripts/validate-translations.js'
      - '.github/workflows/translation-validation.yml'
      - 'TRANSLATION_GUIDE.md'

permissions:
  contents: read

jobs:
  validate-translations:
    runs-on: ubuntu-latest
    
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24'

      - name: Validate all translation files
        id: validate
        run: |
          echo "üåê Validating translations for all 14 languages..."
          echo ""
          npm run validate-translations
          
      - name: Count language files
        id: count
        run: |
          echo ""
          echo "üìä Language file statistics:"
          echo ""
          echo "Total language files: $(ls -1 index*.html | wc -l)"
          echo ""
          for file in index*.html; do
            size=$(wc -c < "$file" | numfmt --to=iec)
            lines=$(wc -l < "$file")
            echo "  $file: $size ($lines lines)"
          done

      - name: Verify RTL languages
        id: rtl
        run: |
          echo ""
          echo "üîÑ Verifying RTL (Right-to-Left) language support:"
          echo ""
          
          # Check Arabic
          if grep -q 'lang="ar" dir="rtl"' index_ar.html; then
            echo "‚úÖ Arabic (ar): RTL support confirmed"
          else
            echo "‚ùå Arabic (ar): RTL support MISSING"
            exit 1
          fi
          
          # Check Hebrew
          if grep -q 'lang="he" dir="rtl"' index_he.html; then
            echo "‚úÖ Hebrew (he): RTL support confirmed"
          else
            echo "‚ùå Hebrew (he): RTL support MISSING"
            exit 1
          fi

      - name: Verify hreflang tags
        id: hreflang
        run: |
          echo ""
          echo "üîó Verifying hreflang tags for SEO:"
          echo ""
          
          for file in index*.html; do
            count=$(grep -c 'hreflang=' "$file" || echo 0)
            if [ "$count" -ge 14 ]; then
              echo "‚úÖ $file: $count hreflang tags (sufficient)"
            else
              echo "‚ö†Ô∏è  $file: $count hreflang tags (should be 14+)"
            fi
          done

      - name: Translation validation summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "   Translation Validation Summary"
          echo "=========================================="
          echo ""
          
          # Check outcomes of previous steps
          if [ "${{ steps.validate.outcome }}" = "success" ]; then
            echo "‚úÖ Translation validation: PASSED"
          else
            echo "‚ùå Translation validation: FAILED"
          fi
          
          if [ "${{ steps.count.outcome }}" = "success" ]; then
            echo "‚úÖ Language file count: PASSED"
          else
            echo "‚ùå Language file count: FAILED"
          fi
          
          if [ "${{ steps.rtl.outcome }}" = "success" ]; then
            echo "‚úÖ RTL support: PASSED"
          else
            echo "‚ùå RTL support: FAILED"
          fi
          
          if [ "${{ steps.hreflang.outcome }}" = "success" ]; then
            echo "‚úÖ Hreflang tags: PASSED"
          else
            echo "‚ùå Hreflang tags: FAILED"
          fi
          
          echo ""
          echo "Languages: EN, SV, DA, NO, FI, DE, FR, ES, NL, AR, HE, JA, KO, ZH"
          echo ""
          echo "=========================================="
